<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Viajes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos anteriores... */
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Vista Principal -->
        <div id="mainView" class="view active">
            <div class="add-trip-form">
                <h2><i class="fas fa-plus-circle"></i> Nuevo Viaje</h2>
                <input type="text" id="tripName" placeholder="Nombre del viaje">
                <input type="date" id="startDate" required>
                <input type="date" id="endDate" required>
                <button class="primary" onclick="addTrip()"><i class="fas fa-plus"></i> Crear Viaje</button>
            </div>

            <div class="trips-list" id="tripsList">
                <!-- Mensaje si no hay viajes -->
                <div id="noTripsMessage" class="hidden">
                    <p>No hay viajes creados. ¡Empieza añadiendo uno!</p>
                </div>
            </div>
        </div>

        <!-- Vista Detalle del Viaje -->
        <div id="detailView" class="view hidden">
            <!-- Contenido detalle... -->
        </div>
    </div>

    <script>
        // Polyfill para Safari
        if (!Date.prototype.toISOString) {
            Date.prototype.toISOString = function() {
                function pad(n) { return n < 10 ? '0' + n : n; }
                return this.getUTCFullYear() + '-' +
                    pad(this.getUTCMonth() + 1) + '-' +
                    pad(this.getUTCDate());
            };
        }

        // Función mejorada para cargar viajes
        function loadTrips() {
            try {
                const storedTrips = localStorage.getItem('trips');
                trips = storedTrips ? JSON.parse(storedTrips) : [];
                
                // Validación de estructura
                if (!Array.isArray(trips)) {
                    throw new Error('Formato de datos inválido');
                }
            } catch (error) {
                console.error('Error cargando viajes:', error);
                trips = [];
                localStorage.setItem('trips', JSON.stringify(trips));
            }
        }

        // Función mejorada para renderizar viajes
        function renderTrips() {
            const list = document.getElementById('tripsList');
            const noTripsMsg = document.getElementById('noTripsMessage');
            
            loadTrips(); // Cargar datos actualizados
            
            if (trips.length === 0) {
                noTripsMsg.classList.remove('hidden');
                list.innerHTML = '';
                return;
            }
            
            noTripsMsg.classList.add('hidden');
            list.innerHTML = trips.map((trip, index) => `
                <div class="trip-card">
                    <button class="delete-btn" onclick="deleteTrip(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                    <div onclick="showDetail(${index})">
                        <h3>${trip.name}</h3>
                        <p>${new Date(trip.startDate).toLocaleDateString('es-ES')} - 
                           ${new Date(trip.endDate).toLocaleDateString('es-ES')}</p>
                        ${trip.cities?.length ? `<p>Ciudades: ${trip.cities.join(', ')}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Función mejorada para añadir viajes
        function addTrip() {
            try {
                const name = document.getElementById('tripName').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!name || !startDate || !endDate) {
                    throw new Error('Por favor completa todos los campos');
                }

                const newTrip = {
                    name,
                    startDate: new Date(startDate).toISOString().split('T')[0],
                    endDate: new Date(endDate).toISOString().split('T')[0],
                    cities: []
                };

                trips.push(newTrip);
                localStorage.setItem('trips', JSON.stringify(trips));
                renderTrips();
                
                // Resetear formulario
                document.getElementById('tripName').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                
            } catch (error) {
                alert(error.message);
                console.error('Error añadiendo viaje:', error);
            }
        }

        // Inicialización mejorada
        document.addEventListener('DOMContentLoaded', () => {
            loadTrips();
            renderTrips();
            
            // Inicializar fechas
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
        });
    </script>
</body>
</html>
